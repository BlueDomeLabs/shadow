#!/bin/bash
# .git/hooks/pre-commit
# EXACT IMPLEMENTATION per 23_ENGINEERING_GOVERNANCE.md Section 6.1

set -e

echo "Running pre-commit checks..."

# 1. Ensure generated files are up to date
echo "Checking generated files..."
dart run build_runner build --delete-conflicting-outputs

# Check for UNSTAGED changes to generated files
# git status --porcelain format: XY filename
#   X = index/staged status, Y = working tree status
# Only fail if Y (column 2) indicates unstaged changes (not a space)
# This allows committing newly staged generated files
if git status --porcelain | grep -E '\.(freezed|g)\.dart$' | grep -qE '^.[^ ]'; then
  echo "ERROR: Generated files have unstaged changes."
  echo "Run: git add <files> to stage them"
  git status --porcelain | grep -E '\.(freezed|g)\.dart$' | grep -E '^.[^ ]'
  exit 1
fi

# 2. Run analyzer
echo "Running analyzer..."
flutter analyze --fatal-infos --fatal-warnings

# 3. Run format check
echo "Checking format..."
dart format --set-exit-if-changed lib/ test/

# 4. Run contract tests
echo "Running contract tests..."
flutter test --tags=contract

# 5. Check commit message format
echo "Checking commit message..."
commit_msg=$(cat "$1" 2>/dev/null || git log -1 --format=%B)
if ! echo "$commit_msg" | grep -qE '^(feat|fix|refactor|test|docs|style|perf|chore)\(.+\): .+'; then
  echo "ERROR: Commit message must follow format: type(scope): subject"
  exit 1
fi

if ! echo "$commit_msg" | grep -qE 'SHADOW-[0-9]+'; then
  echo "ERROR: Commit message must reference a ticket (SHADOW-XXX)"
  exit 1
fi

echo "All pre-commit checks passed!"
