#!/bin/bash
# scripts/pre-commit - SHADOW-014 Implementation
# Pre-commit hook per 23_ENGINEERING_GOVERNANCE.md Section 6.1
#
# Installation: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

echo "Running pre-commit checks..."

# 1. Ensure generated files are up to date
echo "Checking generated files..."
dart run build_runner build --delete-conflicting-outputs 2>/dev/null || {
  echo "WARNING: build_runner failed, skipping generated files check"
}

# Check for UNSTAGED changes to generated files
# git status --porcelain format: XY filename
#   X = index/staged status, Y = working tree status
# Only fail if Y (column 2) indicates unstaged changes (not a space)
# This allows committing newly staged generated files
#
# Examples:
#   "A  file.g.dart" - staged new file, working tree matches index -> OK
#   "M  file.g.dart" - staged modification, working tree matches index -> OK
#   " M file.g.dart" - unstaged modification -> FAIL
#   "AM file.g.dart" - staged new file with unstaged changes -> FAIL
#   "MM file.g.dart" - staged modification with more unstaged changes -> FAIL
if git status --porcelain | grep -E '\.(freezed|g)\.dart$' | grep -qE '^.[^ ]'; then
  echo ""
  echo "ERROR: Generated files have unstaged changes after running build_runner."
  echo "This means your source files have changes that require regeneration."
  echo ""
  echo "The following generated files have unstaged changes:"
  git status --porcelain | grep -E '\.(freezed|g)\.dart$' | grep -E '^.[^ ]'
  echo ""
  echo "To fix: git add <files> to stage them, or check if source files need staging first."
  exit 1
fi

# 2. Run analyzer
echo "Running analyzer..."
flutter analyze --fatal-infos --fatal-warnings || {
  echo ""
  echo "ERROR: flutter analyze found issues."
  echo "Please fix the issues above before committing."
  exit 1
}

# 3. Run format check
echo "Checking format..."
if ! dart format --set-exit-if-changed lib/ test/ 2>/dev/null; then
  echo ""
  echo "ERROR: Code is not properly formatted."
  echo "The following files need formatting:"
  dart format --output=none lib/ test/ 2>/dev/null | grep "Changed" || true
  echo ""
  echo "Run 'dart format lib/ test/' to fix formatting."
  exit 1
fi

echo ""
echo "All pre-commit checks passed!"
